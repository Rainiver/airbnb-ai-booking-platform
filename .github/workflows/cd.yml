name: CD

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          command_timeout: 30m
          script: |
            set -e
            
            # æ¸…ç†å¹¶é‡æ–°å…‹éš†ï¼ˆä½¿ç”¨å…¬å¼€ä»“åº“åœ°å€ï¼‰
            echo "ğŸ§¹ æ¸…ç†æ—§ä»£ç ..."
            rm -rf ~/airbnb-ai-booking-platform
            
            echo "ğŸ“¥ å…‹éš†æœ€æ–°ä»£ç ..."
            git clone https://github.com/Rainiver/airbnb-ai-booking-platform.git ~/airbnb-ai-booking-platform
            cd ~/airbnb-ai-booking-platform
            
            # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
            echo "ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡..."
            cat > .env << 'ENVEOF'
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            FACEBOOK_ID=${{ secrets.FACEBOOK_ID }}
            FACEBOOK_SECRET=${{ secrets.FACEBOOK_SECRET }}
            ENVEOF
            
            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker stop airbnb-app 2>/dev/null || true
            docker rm airbnb-app 2>/dev/null || true
            
            # æ„å»ºæ–°é•œåƒ
            echo "ğŸ—ï¸ æ„å»º Docker é•œåƒï¼ˆé¢„è®¡ 10-15 åˆ†é’Ÿï¼‰..."
            docker build -t airbnb-app:latest .
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ å¯åŠ¨åº”ç”¨..."
            docker run -d --name airbnb-app --restart unless-stopped \
              --env-file .env -p 3000:3000 airbnb-app:latest
            
            # æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f || true
            
            # ç­‰å¾…åº”ç”¨å¯åŠ¨
            echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
            sleep 5
            
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            if docker ps | grep -q airbnb-app; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
              echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.SSH_HOST }}:3000"
            else
              echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
              docker logs airbnb-app
              exit 1
            fi
